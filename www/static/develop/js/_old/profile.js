$(document).ready(function() {
//	$('#islide_profile').click();
	$.mask.definitions['n']='[0-7,9]';
	$('#contact').mask($('#mobtel').data('format')); // @todo

	requirejs(['modules/profile_multiselect'], function(){
		$('.profile-input-select').profileMultiselect();
	});

	// text input onclick
	$('.profile-input').live('click', function(e){
		e.preventDefault();

		var name = $(this).data('name');
		var value = $.trim($(this).text());
		if (value == 'Не указано') {
			value = '';
		}

		var html = ''
			+'<div class="inp-cont-bl autogenerated">'
				+'<div class="inp-profile inp-cont">'
					+'<div class="inp"><input type="text" name="'+name+'" value="'+value+'" /></div>'
				+'</div>'
			+'</div>'
			+'<span class="btn-act apply input-apply autogenerated"></span><span class="btn-act cansel input-cancel autogenerated"></span>'
		+'';

		$(this).parent().hide().after(html);
		
		$('.profile .iinput-bl .inp-cont').on('focus', '.inp', function(){$(this).closest('.inp').addClass('focus')})
		$('.profile .iinput-bl .inp-cont').on('blur', '.inp', function(){$(this).closest('.inp').removeClass('focus')})				
		
		$(this).parent().next().find('input').focus();

		return false;
	});

	// text input save
	$('.input-apply').live('click', function(e){
		e.preventDefault();

		var data = {};
		var key = $(this).parent().find('input').attr('name');
		var obj = this;
		var parent = null;
		data[key] = $(this).parent().find('input').val();

		$.post('/ajax/save_user_data', data, function(json){
			if (json.code == 200 && json.data) {
				parent = $(obj).parents('div.input');
				if ($.trim(json.data[key])) {
					$(obj).prevAll('.profile-input-wrapper').find('.profile-input').text(json.data[key]);
				} else {
					$(obj).prevAll('.profile-input-wrapper').find('.profile-input').text('Не указано');
				}
				$(obj).prevAll('.profile-input-wrapper').show();
				$(obj).parent().find('.autogenerated').remove();
				$(obj).parents('div.input').removeClass('error');
				$(parent).find('.alert-bl').hide();

				if (json.data.user_page) {
					$('.user_page').text(json.data.user_page);
				}
			} else if (json.errors) {
				$(obj).parents('div.input').addClass('error');
				$(obj).parents('div.input').find('.alert-bl').show();
				$(obj).parents('div.input').find('.alert-bl p.text span').html(json.errors);
			}
			
		}, 'json');

		return false;
	});

	// text input cancel
	$('.input-cancel').live('click', function(e){
		e.preventDefault();
		$(this).parents('div.input').removeClass('error');
		$(this).parents('div.input').find('.alert-bl').hide();
		$(this).parents('div.input').find('.alert-bl p.text span').html('');

		$(this).prevAll('.profile-input-wrapper').show();
		$(this).parent().find('.autogenerated').remove();


		return false;
	});

	$('#delete_avatar').click(function(json){
		$.post('/ajax/delete_user_avatar', {}, function(json){
			if (json.code == 200) {
				$('#delete_avatar').hide();
				$('#avatar_img').remove();
				$('#pers-photo').show();
			}
		}, 'json');
	});

	$('#avatar_input').live('change', function(e){
		$.ajaxFileUpload({
			url:'/user/upload_user_avatar', 
			secureuri:false,
			fileElementId:'avatar_input',
			dataType: 'json',
			success: function (json, status) {
				if (json.code == 200) {
					//$('#avatar_img').attr('src', json.filename);
					$('#avatar_img').remove();
					$('.mylogo-bl .filebutton').append('<img id="avatar_img" src="'+ json.filename +'">');
					$('#pers-photo').hide();
					$('#delete_avatar').show();
				} else if (json.error) {
					var div = $('#avatar_input').parents('div.input');
					div.addClass('error');
					div.find('.alert-bl p.text span').html(json.error);
					div.find('.alert-bl').show();
				}
			},
			error: function (data, status, e) {
				console.log(data.responseText);
			}
		});
	});
        

//	$( "#city_selector" ).autocomplete({
//		source: function( request, response ) {
//			request.parent_id = $('#region_kladr_id').val();
//			$.getJSON( "/ajax/kladr_city_autocomplete", request, function( data, status, xhr ) {
//				response( data );
//			});
//		},
//		minLength: 1,
//		delay: 100,
//		autoFocus: true,
//		select: function( event, ui ) {
//			$('#city_kladr_id').val(ui.item.id);
//			$('#region span').html(ui.item.region);
//			// hide error
//			$('#error_city_kladr_id').hide();
//			$('#error_city_kladr_id').parents('div.input').removeClass('error');
//
//			$('#other_cities_checkbox').show();
//
//			$('#address_selector').val('');
//			$('#map_block_div').hide();
//			setTimeout(function(){ 
//				// @todo если сразу делать focus то не корректно срабатывает change, 
//				// ничего лучше setTimeout пока не придумал
//				$('#address_selector').removeAttr('disabled').focus();
//				detect_geoloc();
//			}, 100);
//		},
//		change: function( event, ui ) {
//			if (ui.item == null) {
//				$('#city_selector').val('');
//				$('#city_kladr_id').val('');
//			}
//		}
//	}).data( "ui-autocomplete" )._renderItem = function( ul, item ) {
//		return $( "<li>" )
//		.append( "<a>" + item.label + "</a>" )
//		.appendTo( ul );
//	};

//	$( "#address_selector" ).autocomplete({
//		source: function( request, response ) {
//			request.parent_id = $('#city_kladr_id').val();
//			request.address_required = 0;
//
//			$.getJSON( "/ajax/kladr_address_autocomplete", request, function( data, status, xhr ) {
//				response( data );
//			});
//		},
//		minLength: 1,
//		autoFocus: true,
//		select: function( event, ui ) {
//			$('#address_kladr_id').val(ui.item.id);
//			$('#map_block_div').show();
//
//			$('#error_address').hide();
//			$('#error_address').parents('div.input').removeClass('error');
//			setTimeout(function(){
//				detect_geoloc();
//			}, 100);
//		}
//	}).data( "ui-autocomplete" )._renderItem = function( ul, item ) {
//		return $( "<li>" )
//		.append( "<a>" + item.label + "</a>" )
//		.appendTo( ul );
//	};

	$('[name=address]').on('change, keypress',function(){
//		detect_geoloc();
	});

	$('.city_save').click(function(){
		// save user address
		var coord = $('#coord').val().split(",");
		var address = $('#city_selector').val()+', '+$('input[name=address]').val();

		if (coord.length == 2 && address) {
			$.post('/ajax/save_user_location', {
				lon:coord[0], 
				lat:coord[1], 
				city_kladr_id: $('#city_kladr_id').val(), 
				address_kladr_id: $('#address_kladr_id').val(),
				address:address
				}, function(json){
			if (json.code == 200){
					// @todo
				}
			}, 'json');
		}

		// save user profile
		$.post('/ajax/save_user_data', {
				city_kladr_id: $('#city_kladr_id').val(), 
				org_address:$('input[name=address]').val()
			}, function(json){
			if(json.code == 200) {
				var address = '';
				if ( ! json.data.city_title && ! json.data.org_address) {
					address = 'Не указано';
				} else {
					if (json.data.city_title) {
						address = json.data.city_title;
					}

					if (json.data.org_address) {
						address += ', '+json.data.org_address;
					}
				}

				$('.address_edit').text(address);
				$('#address_edit').hide();
				$('#address_text').show();
			}
		}, 'json');
	});

	$('.city_cancel').click(function(){
		$('#address_edit').hide();
		$('#address_text').show();
	});

	$('.address_edit').click(function(e){
		e.preventDefault();

		$('#address_edit').show();
		$('#address_text').hide();
	});

	$('.delete_verified_contact').live('click', function(){
		if (confirm('Объявления с этим контактом будут сняты с публикации. Хотите удалить контакт?')) {
			var obj = this;
			$.post('/ajax/delete_user_contact', {contact_id:$(this).data('id')}, function(json){
				if (json.code == 200) {
					$(obj).parents('.contact').remove();
				}
			}, 'json');
		}
	});

	$('.delete_contact').live('click', function(){
		var obj = this;
		$.post('/ajax/unlink_user_contact', {contact_id:$(this).data('id')}, function(json){
			if (json.code == 200) {
				$(obj).parents('.contact').remove();
			}
		}, 'json');
	});

	$('.add_contact').click(function(){
		var contact_type_id	= $('#new_contact').find('input[name=contact_type]').val();
		var contact_field	= $('#new_contact').find('input[name=contact]');
		var contact			= $('#new_contact').find('input[name=contact]').val();

		var obj = this;
		$.ajaxSetup({cache:false})
		$.post('/ajax/add_user_contact', {contact_type_id:contact_type_id, contact:contact}, function(json){
			if (json.code == 200) {
				$('#user_contacts').load('/ajax/user_profile_contacts?'+Math.floor(Math.random() * 100));
				$(obj).parents('div.input').find('.alert-bl p.text span').html('');
				$(obj).parents('div.input').find('.alert-bl').hide();
				$(obj).parents('div.input').removeClass('error');
				contact_field.val('');
			} else if (json.error) {
				$(obj).parents('div.input').addClass('error');
				$(obj).parents('div.input').find('.alert-bl p.text span').html(json.error);
				$(obj).parents('div.input').find('.alert-bl').show();
			}
		}, 'json');
		$.ajaxSetup({cache:true})
	});

	$('#org_type').change(function(){
		$.post('/ajax/save_user_data', {org_type:$(this).val()}, function(json){
			if (json.code == 200) {
				window.location.reload();
			}
		}, 'json');
	});

	// about field save
	$('.about_save').click(function(){
		var text = tinyMCE.activeEditor.getContent({format : 'raw'});
		$.post('/ajax/save_user_data', {about:text}, function(json){
			if(json.code == 200) {
				if (json.data.about) {
					$('#about_text span.about_text').html(json.data.about);
					$('#about_edit').hide();
					$('#about_text').show();
				}
			}
		}, 'json');
	});

	$('.about_cancel').click(function(){
		$('#about_edit').hide();
		$('#about_text').show();
	});

	$('.about_edit').click(function(){
		$('#about_edit').show();
		$('#about_text').hide();
	});

	$('.org_type_edit').click(function(e){
		e.preventDefault();

		$('#org_type_edit').show();
		$('#org_type_text').hide();
	});

	$('.org_type_cancel').click(function(){
		$('#org_type_edit').hide();
		$('#org_type_text').show();
	});

	$('#remove_link').click(function(e){
		e.preventDefault();

		var obj = this;

		if (confirm('Удалить привязку к компании?')) {
			$.getJSON('/ajax/remove_link/', function(json) {
				if (json.code == 200) {
					$('#linked_to_block').remove();
				}
			});
		}
	});

	$('.user_link_approve, .user_link_decline').click(function(){
		var obj = this;
		$.getJSON($(obj).data('href'), function(json){
			if (json.code == 200) {
				$('#linked_to_block').load('/block/user_linked_to');
				$('#link_requests_block').remove();
			}
		});
	});

	$('.main_email').click(function(e){
		e.preventDefault();

		$.getJSON('/ajax/set_as_main_email/'+$(this).data('id'), function(json) {
			if (json.code == 200 && json.email) {
				$('#email').text(json.email);
			}
		});
	});

	$('.link_objects').live('click', function(e) {
		e.preventDefault();

		if (confirm('Привязать все объявления с этим контактом к вашей учетной записи?')) {
			$.getJSON('/ajax/link_objects_by_contact/'+$(this).data('id'), function(json) {
				if (json.code == 200) {
					alert('Привязано объявлений:'+json.affected_rows);
				}
			});
		}

		return false;
	});

	requirejs(['modules/profile_contacts', 'modules/addlib'], function(){
		$('#unverified_contacts').profileContacts();
	});
});
